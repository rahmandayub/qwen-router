Research Qwen CLI source code

Read [](file:///home/rahmandayub/Tools/qwen-router/node_modules/%40qwen-code/qwen-code)

Read [](file:///home/rahmandayub/Tools/qwen-router/node_modules/%40qwen-code)

Read [](file:///home/rahmandayub/Tools/qwen-router/node_modules/%40qwen-code/qwen-code/vendor)

Read [](file:///home/rahmandayub/Tools/qwen-router/node_modules/%40qwen-code/qwen-code/package.json)

Read [](file:///home/rahmandayub/Tools/qwen-router/node_modules/%40qwen-code/qwen-code/cli.js#1-1), lines 1 to 100

Searched for regex `portal.*api|api\.qwen|chat\.qwen|dashscope|completions` (`**/qwen-code/cli.js`), 40 results

Searched for regex `rate.limit|retry.after|429|throttl|backoff` (`**/qwen-code/cli.js`), 40 results

Searched for regex `Authorization.*Bearer|x-request-id|x-session|cookie|fingerprint|device.id` (`**/qwen-code/cli.js`), 40 results

Read [](file:///home/rahmandayub/Tools/qwen-router/node_modules/%40qwen-code/qwen-code/cli.js#132700-132700), lines 132700 to 132780

Read [](file:///home/rahmandayub/Tools/qwen-router/node_modules/%40qwen-code/qwen-code/cli.js#19900-19900), lines 19900 to 19970

Read [](file:///home/rahmandayub/Tools/qwen-router/node_modules/%40qwen-code/qwen-code/cli.js#9030-9030), lines 9030 to 9160

Read [](file:///home/rahmandayub/Tools/qwen-router/node_modules/%40qwen-code/qwen-code/cli.js#132780-132780), lines 132780 to 132900

Searched for regex `QWEN_OAUTH|oauthToken|qwen.*oauth|portal.*token|portalToken` (`**/qwen-code/cli.js`), 30 results

Searched for regex `createOpenAI|new OpenAI|openai.*client|createClient|DashScope` (`**/qwen-code/cli.js`), 30 results

Searched for regex `DYNAMIC_QWEN_OAUTH|portalBaseUrl|portal.*url|chat\.qwen|qwenlm\.com|tongyi` (`**/qwen-code/cli.js`), 2 results

Searched for regex `x-request-id|x-dashscope|x-qwen|x-acs|x-session|user-agent.*qwen` (`**/qwen-code/cli.js`), 12 results

Searched for regex `buildHeaders|defaultHeaders|_getHeaders|authHeaders|getAuthHeaders|prepareHeaders` (`**/qwen-code/cli.js`), 30 results

Read [](file:///home/rahmandayub/Tools/qwen-router/node_modules/%40qwen-code/qwen-code/cli.js#141470-141470), lines 141470 to 141600

Read [](file:///home/rahmandayub/Tools/qwen-router/node_modules/%40qwen-code/qwen-code/cli.js#144530-144530), lines 144530 to 144700

Read [](file:///home/rahmandayub/Tools/qwen-router/node_modules/%40qwen-code/qwen-code/cli.js#132130-132130), lines 132130 to 132250

Read [](file:///home/rahmandayub/Tools/qwen-router/node_modules/%40qwen-code/qwen-code/cli.js#141600-141600), lines 141600 to 141750

Read [](file:///home/rahmandayub/Tools/qwen-router/node_modules/%40qwen-code/qwen-code/cli.js#144700-144700), lines 144700 to 144900

Searched for regex `SharedTokenManager|sharedTokenManager|tokenManager` (`**/qwen-code/cli.js`), 20 results

Read [](file:///home/rahmandayub/Tools/qwen-router/node_modules/%40qwen-code/qwen-code/cli.js#143666-143666), lines 143666 to 143990

Read [](file:///home/rahmandayub/Tools/qwen-router/node_modules/%40qwen-code/qwen-code/cli.js#143990-143990), lines 143990 to 144200

Searched for regex `OpenAIContentGenerator|openaiContentGenerator2|class.*ContentGenerator` (`**/qwen-code/cli.js`), 20 results

Read [](file:///home/rahmandayub/Tools/qwen-router/node_modules/%40qwen-code/qwen-code/cli.js#141816-141816), lines 141816 to 141950

Read [](file:///home/rahmandayub/Tools/qwen-router/node_modules/%40qwen-code/qwen-code/cli.js#141408-141408), lines 141408 to 141465

Read [](file:///home/rahmandayub/Tools/qwen-router/node_modules/%40qwen-code/qwen-code/cli.js#142048-142048), lines 142048 to 142200

Searched for regex `class OpenAIContentGenerator` (`**/qwen-code/cli.js`), no results

Searched for regex `executeWithErrorHandling` (`**/qwen-code/cli.js`), 4 results

Searched for regex `DEFAULT_QWEN_MODEL` (`**/qwen-code/cli.js`), 10 results

Read [](file:///home/rahmandayub/Tools/qwen-router/node_modules/%40qwen-code/qwen-code/cli.js#141950-141950), lines 141950 to 142050

Read [](file:///home/rahmandayub/Tools/qwen-router/node_modules/%40qwen-code/qwen-code/cli.js#132540-132540), lines 132540 to 132570

Searched for regex `resource_url|resourceUrl|resource\.url` (`**/qwen-code/cli.js`), 15 results

Searched for regex `shouldRetry.*status|retryRequest|calculateDefaultRetryTimeout` (`**/qwen-code/cli.js`), 10 results

Searched for regex `convertGeminiToolsToOpenAI|tools.*function|tool_choice` (`**/qwen-code/cli.js`), 10 results

Read [](file:///home/rahmandayub/Tools/qwen-router/node_modules/%40qwen-code/qwen-code/cli.js#247830-247830), lines 247830 to 247870

Read [](file:///home/rahmandayub/Tools/qwen-router/node_modules/%40qwen-code/qwen-code/cli.js#141020-141020), lines 141020 to 141220

Read [](file:///home/rahmandayub/Tools/qwen-router/node_modules/%40qwen-code/qwen-code/cli.js#141220-141220), lines 141220 to 141420

Searched for regex `authHeaders\(options` (`**/qwen-code/cli.js`), 1 result

Searched for regex `authHeaders\(\)|authHeaders\(opts\)|async authHeaders` (`**/qwen-code/cli.js`), 4 results

Read [](file:///home/rahmandayub/Tools/qwen-router/node_modules/%40qwen-code/qwen-code/cli.js#140955-140955), lines 140955 to 140990

Searched for regex `convertGeminiToolsToOpenAI` (`**/qwen-code/cli.js`), 3 results

Read [](file:///home/rahmandayub/Tools/qwen-router/node_modules/%40qwen-code/qwen-code/cli.js#131206-131206), lines 131206 to 131290

Read [](file:///home/rahmandayub/Tools/qwen-router/server.js#1-1), lines 1 to 200

Searched for regex `AuthType2\.(QWEN_OAUTH|USE_OPENAI)|AuthType2\s*=` (`**/qwen-code/cli.js`), 10 results

Searched for regex `quotaError|QuotaError|overloaded|rate_limit|RateLimitError` (`**/qwen-code/cli.js`), 10 results

Searched for regex `quotaErrorDetection|isQuotaError|quota_exceeded` (`**/qwen-code/cli.js`), 8 results

Read [](file:///home/rahmandayub/Tools/qwen-router/node_modules/%40qwen-code/qwen-code/cli.js#129941-129941), lines 129941 to 130000

Read [](file:///home/rahmandayub/.config/Code/User/workspaceStorage/c223c1a277ed68cbeecece877827989a/GitHub.copilot-chat/chat-session-resources/04707b53-6f47-4054-8370-9470dca1aa92/toolu_01TLjgNyr11Uueo32y8enZik__vscode-1770962796713/content.txt#1-1), lines 1 to 300

Read [](file:///home/rahmandayub/.config/Code/User/workspaceStorage/c223c1a277ed68cbeecece877827989a/GitHub.copilot-chat/chat-session-resources/04707b53-6f47-4054-8370-9470dca1aa92/toolu_01TLjgNyr11Uueo32y8enZik__vscode-1770962796713/content.txt#300-300), lines 300 to 310

Excellent research. Now let me verify a few critical details:

Verify Qwen CLI details

Read [](file:///home/rahmandayub/.qwen/oauth_creds.json)

Read [](file:///home/rahmandayub/Tools/qwen-router/node_modules/%40qwen-code/qwen-code/cli.js#144540-144540), lines 144540 to 144620

Read [](file:///home/rahmandayub/Tools/qwen-router/node_modules/%40qwen-code/qwen-code/cli.js#141496-141496), lines 141496 to 141600

Read [](file:///home/rahmandayub/Tools/qwen-router/node_modules/%40qwen-code/qwen-code/cli.js#132530-132530), lines 132530 to 132580

Read [](file:///home/rahmandayub/Tools/qwen-router/node_modules/%40qwen-code/qwen-code/cli.js#141140-141140), lines 141140 to 141230

Read [](file:///home/rahmandayub/Tools/qwen-router/node_modules/%40qwen-code/qwen-code/cli.js#141850-141850), lines 141850 to 141920

Searched for text `QwenCode/` (`**/cli.js`), 7 results

Searched for regex `refresh_token.*grant_type|grant_type.*refresh_token` (`**/cli.js`), 10 results

Searched for regex `coder-model` (`**/cli.js`), 10 results

Searched for regex `DEFAULT_MAX_RETRIES|DEFAULT_TIMEOUT|DEFAULT_DASHSCOPE_BASE_URL` (`**/cli.js`), 10 results

Searched for regex `getCliVersion|CLI_VERSION` (`**/cli.js`), 5 results

Read [](file:///home/rahmandayub/Tools/qwen-router/node_modules/%40qwen-code/qwen-code/cli.js#144665-144665), lines 144665 to 144730

Read [](file:///home/rahmandayub/Tools/qwen-router/node_modules/%40qwen-code/qwen-code/cli.js#132620-132620), lines 132620 to 132760

Read [](file:///home/rahmandayub/Tools/qwen-router/node_modules/%40qwen-code/qwen-code/cli.js#243035-243035), lines 243035 to 243060

Read [](file:///home/rahmandayub/Tools/qwen-router/node_modules/%40qwen-code/qwen-code/cli.js#132810-132810), lines 132810 to 132830

Searched for regex `cliVersion\s*=\s*"` (`**/cli.js`), no results

Searched for regex `shouldEnableCacheControl` (`**/cli.js`), 2 results

Searched for regex `cliVersion\s*=\s*"` (`**/cli.js`), no results

Read [](file:///home/rahmandayub/Tools/qwen-router/node_modules/%40qwen-code/qwen-code/cli.js#141720-141720), lines 141720 to 141740

Searched for regex `CLI_VERSION|"version":\s*"0\.|"version":\s*"1\.` (`**/cli.js`), no results

Searched for regex `this\.cliVersion\s*=` (`**/cli.js`), 1 result

Read [](file:///home/rahmandayub/Tools/qwen-router/node_modules/%40qwen-code/qwen-code/package.json#1-1), lines 1 to 10

Now I have complete understanding of the CLI internals. Let me verify one more thing about the current `resource_url`:

Read [](file:///home/rahmandayub/Tools/qwen-router/server.js#1-1), lines 1 to 10

Good. Here's the comprehensive plan:

---

## Plan: Replace CLI with Native API Client

**TL;DR** — Rewrite the router to call the Qwen API directly for **all** requests (not just tool calls), mimicking the exact request logic from the Qwen Code CLI. This eliminates the CLI subprocess, avoids the current hybrid routing, and properly supports tool calling. The key insight from the CLI source: there's **no secret rate-limit bypass** — the CLI uses the OpenAI SDK with exponential backoff retries (3 retries, 0.5s→8s), DashScope-specific headers (`X-DashScope-CacheControl`, `X-DashScope-UserAgent`, `X-DashScope-AuthType`), prompt caching via `cache_control` annotations, and dynamic endpoint resolution from `resource_url` in the OAuth credentials. The current `portal.qwen.ai` endpoint happens to match your credential's `resource_url`, but the proper approach is reading it dynamically.

**Steps**

1. **Replace axios with OpenAI SDK** — Use the `openai` package (already in package.json) to create the HTTP client, matching the CLI's constructor at cli.js:
    - `timeout: 120000` (2 min, not 5 min like current axios)
    - `maxRetries: 3`
    - Custom `defaultHeaders` with DashScope headers
    - Dynamic `baseURL` from `resource_url` in OAuth creds

2. **Implement DashScope headers** — Add these to every request, matching cli.js:
    - `User-Agent: QwenCode/0.10.1 (linux; x64)`
    - `X-DashScope-CacheControl: enable`
    - `X-DashScope-UserAgent: QwenCode/0.10.1 (linux; x64)`
    - `X-DashScope-AuthType: qwen-oauth`

3. **Implement direct OAuth token refresh** — Replace the `refreshTokenViaCLI()` (spawns `qwen --version`) with a direct HTTP call matching cli.js:
    - `POST https://chat.qwen.ai/api/v1/oauth2/token`
    - Body: `grant_type=refresh_token&refresh_token=<token>&client_id=f0304373b74a44d2b584a3fb70ca9e56`
    - Content-Type: `application/x-www-form-urlencoded`
    - Write refreshed credentials back to `~/.qwen/oauth_creds.json`
    - Add file-locking (the CLI uses `SharedTokenManager` with cross-process locks at cli.js)

4. **Add `metadata` to request body** — Matching cli.js:

    ```
    metadata: { sessionId: <uuid>, promptId: <uuid-per-request>, channel: "SDK" }
    ```

5. **Implement DashScope prompt caching** — Add `cache_control: { type: "ephemeral" }` annotations matching cli.js:
    - On system message content (first element or wrap)
    - On last user message content (last element)
    - On last tool in `tools[]` array
    - Only when `stream: true`

6. **Add `stream_options`** — When streaming, include `stream_options: { include_usage: true }` to get token counts

7. **Use `coder-model` as default model** — Map incoming model names: the API resolves `coder-model` server-side (same as CLI's `DEFAULT_QWEN_MODEL` at cli.js). Create a model map:
    - `qwen3-coder-plus` → `coder-model` (or pass through)
    - `qwen3-coder-flash` → `coder-model`
    - Keep existing model name if it's already a valid Qwen API model

8. **Implement retry with exponential backoff** — Match cli.js:
    - Retry on: 408, 409, 429, 5xx
    - Backoff: `min(0.5 * 2^n, 8) * (1 - random*0.25)` seconds
    - Max 3 retries
    - Honor `Retry-After` / `Retry-After-Ms` headers
    - (The OpenAI SDK handles this automatically when configured with `maxRetries: 3`)

9. **Remove CLI subprocess path entirely** — Delete `proxyViaCLI()` and the hybrid routing. All requests (with and without tools) go through the direct API client. Remove `QWEN_CLI_PATH` from config.

10. **Dynamic endpoint from credentials** — Read `resource_url` from `oauth_creds.json` and build the base URL at cli.js: `https://${resource_url}/v1`. Fall back to `https://dashscope.aliyuncs.com/compatible-mode/v1`.

11. **Forward OpenAI-compatible request/response** — Since `portal.qwen.ai/v1` (the resolved endpoint) already returns native OpenAI-format responses with `tool_calls`, `finish_reason: "tool_calls"`, etc., the router becomes a thin authenticated proxy — no format conversion needed.

**Verification**

- `node -c server.js` — syntax check
- `curl localhost:4000/health` — verify token loaded, endpoint resolved
- Tool call test: POST with `tools[]` → expect `finish_reason: "tool_calls"` with structured `tool_calls`
- Regular chat test: POST without tools → expect normal `content` response
- Streaming test: POST with `stream: true` → expect SSE chunks
- Rate limit test: rapid-fire 10 requests → verify retries work (should see retry log, no crashes)
- Token expiry test: set a fake expired `expiry_date` → verify auto-refresh triggers

**Decisions**

- **OpenAI SDK over axios**: The CLI uses the same OpenAI SDK (already in package.json). It provides built-in retry, streaming, timeout, and header management — less custom code.
- **Direct token refresh over CLI spawn**: Eliminates subprocess overhead and the 30s `--version` timeout. Direct HTTP is faster and more reliable.
- **No CLI fallback**: The CLI doesn't have special rate-limit magic — it uses the same retry logic we'll implement. Removing the CLI path simplifies the codebase to a single request path.
- **`coder-model` as default**: Matches CLI behavior; the API resolves it server-side to the best available model.
